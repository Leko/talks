import { Head } from "mdx-deck";
import { Split } from "mdx-deck/layouts";
import { CodeSurfer } from "mdx-deck-code-surfer";
import vsDarkPlus from "prism-react-renderer/themes/vsDarkPlus";
import { Meta } from "./Meta";
export { default as theme } from "./theme";

<Head>
  <Meta
    title="TSerã®éŠã³å ´ï¼šTS playground plugin"
    description="UIT meetup vol.8 onlineã€ŒWe Are TypeScripters!ã€"
    slug="our-toys-your-sandbox"
    publishedAt={new Date(2020, 2, 18)}
  />
  <link
    href="https://fonts.googleapis.com/earlyaccess/notosansjapanese.css"
    rel="stylesheet"
  />
</Head>

# TSerã®éŠã³å ´ï¼šTS playground plugin

[UIT meetup vol.8 onlineã€ŒWe Are TypeScripters!ã€](https://uit.connpass.com/event/161964/)  
Leko

---

## Leko

<img src="/assets/self_avatar.png" height="280" />
<img src="/assets/our-toys-your-sandbox/2020-03-18-01-56-03.png" height="280" />
<img src="/assets/our-toys-your-sandbox/2020-03-18-01-55-12.png" height="280" />

JS/TSã‚ªã‚¿ã‚¯ã§ã™

---

## :tada: V2 :tada:

2020/03/18æ™‚ç‚¹ã§ã¯`/v2/`ã¤ã‘ã‚‹ã¨ã‚¢ã‚¯ã‚»ã‚¹ã§ããã†

<img src="/assets/type-boundary-on-typescript/2020-03-15-18-33-05.png" width="70%" />

---

<img src="/assets/our-toys-your-sandbox/2020-03-18-02-19-14.png" width="70%" />

<img src="/assets/our-toys-your-sandbox/2020-03-18-02-20-32.png" width="70%" />

---

## :tada: æ—¥æœ¬èª :tada:

<img src="/assets/type-boundary-on-typescript/2020-03-15-18-38-10.png" width="70%" />

> &mdash; [Japanese Translation Coordination Issue Â· Issue #220 Â· microsoft/TypeScript-Website](https://github.com/microsoft/TypeScript-Website/issues/220)  
> &mdash; [Website Internationalization Roadmap Â· Issue #100 Â· microsoft/TypeScript-Website](https://github.com/microsoft/TypeScript-Website/issues/100)

---

## ãã£ã‹ã‘

<img src="/assets/typescript-v2-playground-plugin/2020-03-03-16-15-40.png" width="50%" />

> &mdash; [gql`quramy { name }` on Twitter: "#typescript My first playground plugin works :) https://t.co/8OHq0i07BX" / Twitter](https://twitter.com/Quramy/status/1224714244500918272)

---

## Playground plugin? :thinking_face:

<img src="/assets/typescript-v2-playground-plugin/2020-03-04-13-03-13.png" width="100%" />

---

## TypeScript playground plugin

https://www.typescriptlang.org/v2/dev/playground-plugins/

- TypeScript v2 docs is under development
- New playground has plugin system :face_with_rolling_eyes:
- It can load local plugin through localhost :exploding_head:

---

# TL;DR
## TS playground pluginã¨ã„ã†éŠã³å ´ãŒãã§ãŸã€‚TSã®ãƒ¡ã‚¿ã‚’éŠã‚“ã§è¦šãˆã¦æ¥½ã—ã‚‚ã†

---

## ä¾‹ãˆã°ã“ã†ã„ã†ã“ã¨ãŒã§ãã‚‹

- [.d.tsã‚’è§£æã—ã¦ç ´å£Šçš„å¤‰æ›´ã‚’æ¤œçŸ¥ã™ã‚‹](https://talks.leko.jp/semver-detection-on-typescript/#0)
- [OpenAPIå®šç¾©ã‹ã‚‰expressã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å‹ã‚’ç”Ÿæˆ](https://speakerdeck.com/andoshin11/type-safe-everything)
- [ã“ã¡ã‚‰CompilerAPIæ´¾å‡ºæ‰€anyè­¦å¯Ÿã§ã™ğŸ‘®â€â™‚ï¸ - Qiita](https://qiita.com/Takepepe/items/3353159894ed57b6f0a8)
- [TypeScript CompilerAPI ã«ã‚ˆã‚‹Vuexã®å‚ç…§å‹ç”Ÿæˆ](https://speakerdeck.com/takefumiyoshii/typescript-compilerapi-niyoruvuexfalsecan-zhao-xing-sheng-cheng)
- [Monaco Editor ã‚’ãƒãƒƒã‚¯ã™ã‚‹ - Qiita](https://qiita.com/mizchi/items/5c5cb5abcb22d87f9031)
- [å‹ã¨å‘½åï¼ˆisXXX, hasXXX etcï¼‰ã®æ•´åˆæ€§ã‚’lintã™ã‚‹](https://speakerdeck.com/takefumiyoshii/regular-expression-and-type-naming-rule-linter)
- [Docã‚³ãƒ¡ãƒ³ãƒˆã«å‹•ããƒ†ã‚¹ãƒˆã‚’æ›¸ã](https://akito0107.github.io/ts-compiler-api-slide/#slide=1)

---

## è©¦ã—ã¦ã¿ã‚‹

- V2 playgroundé–‹ã
- `Options`ã‚¿ãƒ–é–‹ã
- Custom npm Modulesã«ã€  
  `ts-playground-plugin-stackoverflow`ã¨å…¥åŠ›
- ãƒªãƒ­ãƒ¼ãƒ‰

<img src="/assets/typescript-v2-playground-plugin/2020-03-04-13-16-07.png" width="70%" />

---

## ä»Šå›ä½œã£ãŸã‚‚ã®

<img src="/assets/typescript-v2-playground-plugin/2020-03-04-13-08-16.png" width="100%" />

playgroundã®ã‚¨ãƒ©ãƒ¼ã¨é¡ä¼¼ã®ã‚¨ãƒ©ãƒ¼ã‚’Stackoverflowã‹ã‚‰æ¢ã—ã¦ã‚µã‚¸ã‚§ã‚¹ãƒˆã™ã‚‹playgroundãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã€‚  
ç²¾åº¦ã¯ã”æ„›å¬Œ... :pray:

> &mdash; [Leko/ts-playground-plugin-stackoverflow](https://github.com/Leko/ts-playground-plugin-stackoverflow)

---

## ã‚„ã£ã¦ã‚‹ã“ã¨

- ã‚³ãƒ¼ãƒ‰ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰å‹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿæ–½
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’StackExchange APIã§æ¤œç´¢
- æ•´å½¢ã€å‡ºåŠ›

---

## å¿…è¦çŸ¥è­˜

- TypeScript playground plugin
  - ã‚³ã‚¢éƒ¨åˆ†
- TypeScript Compiler API/LanguageService
  - å‹ãƒã‚§ãƒƒã‚¯ã¨ã‹ã‚¨ãƒ©ãƒ¼ã®æ•´å½¢ã¨ã‹
- Monaco editor
  - ã‚¨ãƒ‡ã‚£ã‚¿ã¨pluginã®ã‚„ã‚Šã¨ã‚Š
- Stackexchange API
  - Stackoverflowã‹ã‚‰ã‚¨ãƒ©ãƒ¼ã‚’æ¤œç´¢ã™ã‚‹

---

## è©±ã™ã“ã¨ã€è©±ã•ãªã„ã“ã¨

- **TypeScript playground plugin** (ã‚µãƒ–)
  - ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ©Ÿæ§‹ã‚„ä½¿ãˆã‚‹APIã€ãƒ•ãƒƒã‚¯ãªã©
- **TypeScript Compiler API/LanguageService** (ãƒ¡ã‚¤ãƒ³)
  - å‹ãƒã‚§ãƒƒã‚¯ã€ã‚¨ãƒ©ãƒ¼ã®æ•´å½¢ã¨ã‹è§¦ã‚Šã ã‘
- Monaco editor (å‰²æ„›)
  - [å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ»å‹è§£é‡ˆã§ãã‚‹TypeScript playgroundã‚’ä½œã£ãŸ](https://talks.leko.jp/advanced-typescript-playground/#0)
  - [Monaco Editor ã‚’ãƒãƒƒã‚¯ã™ã‚‹ - Qiita](https://qiita.com/mizchi/items/5c5cb5abcb22d87f9031)
- Stackexchange API (å‰²æ„›)
  - [APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://api.stackexchange.com/docs/advanced-search)
  - [APIå©ã„ã¦ã‚‹ã‚³ãƒ¼ãƒ‰](https://github.com/Leko/ts-playground-plugin-stackoverflow/blob/97d53315ccc45712b0af452f532a837cefc5d485/src/index.ts#L6-L17)

---

# Playground plugin

ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ©Ÿæ§‹ã‚„ä½¿ãˆã‚‹APIã€ãƒ•ãƒƒã‚¯ãªã©

---

## ãŠãŠã¾ã‹ãªé–‹ç™ºã®æµã‚Œ

1. ãƒ†ãƒ³ãƒ—ãƒ¬ã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆ
1. ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
1. ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ›¸ã
1. npm publish
1. playgroundã«èª­ã¿è¾¼ã¾ã›ã¦ä½¿ã†

---

## ãƒ†ãƒ³ãƒ—ãƒ¬ã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆ

https://www.typescriptlang.org/v2/dev/playground-plugins/

```sh
yarn create typescript-playground-plugin xxx
cd xxx
yarn start
```

ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã‚‚ãƒ†ãƒ³ãƒ—ãƒ¬ã‹ã‚‰ä½œã£ã¦ã‚‹:  
[Leko/ts-playground-plugin-stackoverflow](https://github.com/Leko/ts-playground-plugin-stackoverflow)

---

## ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

- æœ¬ç•ªplaygroundã‹ã‚‰localhsotã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’èª­ã‚ã‚‹  
- ãƒ­ãƒ¼ã‚«ãƒ«ã«playground cloneã—ãªãã¦ã„ã„

<img src="/assets/typescript-v2-playground-plugin/2020-03-03-16-42-33.png" width="100%" />

---

## Overview

```ts
import type { PlaygroundPlugin, PluginUtils } from "./vendor/playground"

export default (utils: PluginUtils): PlaygroundPlugin => {
  return {
    id: 'xxx',
    displayName: 'ã‚¿ãƒ–ã®åå‰',

    didMount(sandbox, container) {
      // ...
    },

    modelChangedDebounce(sandbox, model) {
      // ...
    },
  }
}
```

---

## pluginã®ãƒ•ãƒƒã‚¯

- didMount
  - Event: ã‚¿ãƒ–ãŒé¸æŠã•ã‚Œç”»é¢ã«è¡¨ç¤ºã•ã‚ŒãŸ
  - ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã€åˆæœŸæç”»ãªã©
- modelChanged(Debounce)
  - Event: ã‚¨ãƒ‡ã‚£ã‚¿ã®ã‚³ãƒ¼ãƒ‰ãŒå¤‰æ›´ã•ã‚ŒãŸ
  - ã‚³ãƒ¼ãƒ‰ã«å¯¾ã—ã¦**ä½•ã‹**ã—ã¦ç”»é¢ã«è¡¨ç¤ºã™ã‚‹

ã“ã‚Œä»¥å¤–ã®ãƒ•ãƒƒã‚¯ã¯ç”Ÿæˆã•ã‚ŒãŸ`PlaygroundPlugin`ã®å‹å®šç¾©ã‚’å‚ç…§

---

# Compiler API / Language Service
ã‚³ãƒ¼ãƒ‰ã«å¯¾ã—ã¦ä½•ã‹ï¼ˆå‹ãƒã‚§ãƒƒã‚¯ã€ã‚¨ãƒ©ãƒ¼ã®æ•´å½¢ï¼‰ã—ã¦ç”»é¢ã«è¡¨ç¤ºã™ã‚‹

---

<CodeSurfer
  title="å‹ãƒã‚§ãƒƒã‚¯"
  notes="https://github.com/Leko/ts-playground-plugin-stackoverflow/blob/97d53315ccc45712b0af452f532a837cefc5d485/src/index.ts#L71-L86"
  code={require('!raw-loader!assets/our-toys-your-sandbox/type-checking.ts')}
  lang="typescript"
  showNumbers={false}
  theme={vsDarkPlus}
  dark
  steps={[
    { lines: [1], notes: "ã‚³ãƒ¼ãƒ‰ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ã" },
    { lines: [2], notes: "Monaco editorã¨TS Compiler APIã‚’ã¤ãªãWebWorkerã®ãƒ—ãƒ­ã‚»ã‚¹" },
    { tokens: { 4: [4,5,6,7,8,9,10], 5: [4,5,6,7,8,9,10] }, notes: "ã‚¨ãƒ‡ã‚£ã‚¿ä¸Šã«æ›¸ã‹ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã®ä»®æƒ³FSã®URIã‚’æ¸¡ã—ã¦" },
    { tokens: { 4: [0,1,2,3,11], 5: [0,1,2,3,11] }, notes: "æ–‡è„ˆä¸Šã®å‹ã‚¨ãƒ©ãƒ¼ã¨æ§‹æ–‡çš„ãªå‹ã‚¨ãƒ©ãƒ¼ã‚’å–å¾—ï¼ˆPromise<Array<Diagnostic>>ï¼‰" },
    { range: [8,10], notes: "Promise<Array<Diagnostic>>ã‚’ï¼‘ã¤ã«ã¾ã¨ã‚ã‚‹" },
    { tokens: { 11: [4] }, notes: "diagnostics.length === 0 ãªã‚‰ã‚¨ãƒ©ãƒ¼ãªã—" },
  ]}
/>

---

## Diagnostic

```ts
    export interface DiagnosticRelatedInformation {
        category: DiagnosticCategory;
        code: number;
        file: SourceFile | undefined;

        // ã‚³ãƒ¼ãƒ‰ä¸Šã®ã‚¨ãƒ©ãƒ¼é–‹å§‹ä½ç½®
        start: number | undefined;

        // ã‚¨ãƒ©ãƒ¼ãŒèµ·ã“ã£ã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ã®é•·ã•
        length: number | undefined;

        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ OR ãƒã‚¹ãƒˆã—ãŸã‚¨ãƒ©ãƒ¼
        messageText: string | DiagnosticMessageChain;
    }
    export interface Diagnostic extends DiagnosticRelatedInformation {
        /** ... */
        reportsUnnecessary?: {};
        source?: string;
        relatedInformation?: DiagnosticRelatedInformation[];
    }
```

---

## ã‚¨ãƒ©ãƒ¼å†…å®¹ã®æ•´å½¢ã€è¡¨ç¤º

<img src="/assets/typescript-v2-playground-plugin/2020-03-04-13-08-16.png" width="100%" />

---

## ã‚¨ãƒ©ãƒ¼ã®æ•´å½¢ã‚’åˆ†è§£

```plain
1: const port = process.env.PORT;
                ^^^^^^^
```

â†‘start, lengthã‹ã‚‰è©²å½“è¡Œã€ã‚¨ãƒ©ãƒ¼ç®‡æ‰€ã‚’æŠ½å‡ºï¼ˆ[ã‚³ãƒ¼ãƒ‰](https://github.com/Leko/ts-playground-plugin-stackoverflow/blob/97d53315ccc45712b0af452f532a837cefc5d485/src/index.ts#L19-L27)ï¼‰

```plain
error TS2580: Cannot find name 'process'. Do you need to install type definitions for node? Try
`npm i @types/node`.
```

â†‘Compiler APIã®ä¸€éƒ¨ã‚’ä½¿ç”¨

---

## `messageText`ã¨ã„ã„ã¤ã¤stringã§ã¯ãªã„

```ts
        messageText: string | DiagnosticMessageChain;
```

---

## ts.formatDiagnositc

```ts
import type { FormatDiagnosticsHost } from 'typescript'

const formatDiagnosticHost: FormatDiagnosticsHost = { /* ... */ }
const errorMessage = ts.formatDiagnostic(d, formatDiagnosticHost)
```

FormatDiagnosticsHost... :thinking_face:

---

## FormatDiagnosticsHost

- `~Host`ã¯TSã‚’ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ éä¾å­˜ã™ã‚‹ãŸã‚ã®DI
- ãƒ–ãƒ©ã‚¦ã‚¶ã‚„Denoãªã©ä»»æ„ã®ï¼ˆä»®æƒ³ï¼‰FSã«å¯¾ã—ä½¿ãˆã‚‹
- ä»–ã«ã¯CompilerHost, LanguageServiceHostãªã©

```ts
declare namespace ts {
    // ...
    export interface FormatDiagnosticsHost {
        getCurrentDirectory(): string;
        getCanonicalFileName(fileName: string): string;
        getNewLine(): string;
    }
```

---

## é›‘ãªå®Ÿè£…ä¾‹

```ts
const formatDiagnosticHost: FormatDiagnosticsHost = {
  getCurrentDirectory() {
    // playgroundã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ¦‚å¿µã¯ãªã„ã®ã§å‹ã ã‘åˆã‚ã›ã‚‹
    return ''
  },
  getCanonicalFileName(fileName: string) {
    // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚‚ãªã„ã®ã§ãã®ã¾ã¾è¿”ã™
    return fileName
  },
  getNewLine() {
    return '\\n'
  }
}
```

---

## HTMLã«æ•´ãˆã¦å®Œæˆ

<img src="/assets/typescript-v2-playground-plugin/2020-03-04-13-08-16.png" width="100%" />

---

## ã‚¢ã‚¤ãƒ‡ã‚¢æ¬¡ç¬¬ã€ã‚ãªãŸæ¬¡ç¬¬ã€‚

<img src="/assets/our-toys-your-sandbox/2020-03-18-12-16-32.png" width="100%" />

> &mdash; [TypeScript Playground Plugin ideas Â· Issue #221 Â· microsoft/TypeScript-Website](https://github.com/microsoft/TypeScript-Website/issues/221)

---

# Playground pluginã®ã™ã”ã„ã¨ã“ã‚

- TSæœ¬ä½“ã«è§¦ã‚Œãªãã¦ã„ã„ã€3rd-partyãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ã—ã¦ä½œã‚Œã‚‹
- ã‚¢ã‚¤ãƒ‡ã‚¢æ¬¡ç¬¬ã§éå¸¸ã«å¼·åŠ›
- ä»–äººã«ä½¿ã£ã¦ã‚‚ã‚‰ã„ã‚„ã™ã„
- é–‹ç™ºã—ã‚„ã™ã„

---

## FAQ

- Q. ä½•ã‚’ã©ã†ã‚„ã£ã¦å‹‰å¼·ã—ãŸã‚‰ã„ã„ã§ã™ã‹
  - A. [å…¬å¼ã®wiki](https://github.com/microsoft/TypeScript/wiki/Using-the-Compiler-API), [TypeScript Compiler Internals](https://basarat.gitbook.io/typescript/overview)èª­ã¿ã¤ã¤ã²ãŸã™ã‚‰ãƒ‡ãƒãƒƒã‚°
  - å…ˆäººãŒä½œã£ãŸã‚‚ã®ã®ã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°

- Q. ç”»é¢ã¸ã®åæ˜ ã£ã¦ã©ã†ã—ã¦ã¾ã™ã‹
  - A. ç”ŸDOM APIå©ã„ã¦ã¾ã™

- Q. ç”ŸDOMè§¦ã‚‹ã®ã¤ã‚‰ããªã„ã§ã™ã‹
  - A. Reactç­‰ã§æ›¸ã‘ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚‚ç”¨æ„ã•ã‚Œã¦ã¾ã™
  - React: [gojutin/typescript-playground-plugin-react](https://github.com/gojutin/typescript-playground-plugin-react#typescript-playground-plugin-react)
  - Svelte: [gojutin/typescript-playground-plugin-svelte](https://github.com/gojutin/typescript-playground-plugin-svelte#typescript-playground-plugin-svelte)
  - Angular, Vueç‰ˆã¯ã¾ã ãªã„ï¼ˆ**è²¢çŒ®ãƒãƒ£ãƒ³ã‚¹**ï¼‰

---

## çµ‚ã‚ã‚Š

- References
  - [Playground plugin ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://www.typescriptlang.org/v2/dev/playground-plugins/)
  - [ä»Šå›ä½œã£ãŸãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/Leko/ts-playground-plugin-stackoverflow)
- Related talks
  - [TypeScript v2 playground plugin](https://talks.leko.jp/typescript-v2-playground-plugin/#0)
  - ["å‹ãƒ‘ã‚ºãƒ«"ã¨ã®ä»˜ãåˆã„æ–¹](https://talks.leko.jp/type-puzzle-world/#0)
  - [å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ»å‹è§£é‡ˆã§ãã‚‹TypeScript playgroundã‚’ä½œã£ãŸ](https://talks.leko.jp/advanced-typescript-playground/#0)
  - [.d.tsã‚’è§£æã—ã¦ç ´å£Šçš„å¤‰æ›´ã‚’æ¤œçŸ¥ã™ã‚‹](https://talks.leko.jp/semver-detection-on-typescript/#0)
